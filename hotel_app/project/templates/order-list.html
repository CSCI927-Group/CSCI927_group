{% extends 'layout.html' %}

{% block title %}Order List{% endblock %}

{% block content %}
<div class="container col-md-8 mx-auto my-5">
  <div class="table-responsive">
    <table class="table" style="width: 100%; max-width: none;">
      <thead>
        <tr>
          <th scope="col" style="width: 20%;">Name</th>
          <th scope="col" style="width: 20%;">Price</th>
          <th scope="col" style="width: 20%;">Date</th>
          <th scope="col" style="width: 20%;">State</th>
          <th scope="col" style="width: 20%;">Operate</th>
        </tr>
      </thead>
      <tbody>
        {% for item in list %}
        <tr id="order-row-{{ item.id }}">
          <td>{{ item.name }}</td>
          <td>${{ item.price }}</td>
          <td>{{ item.startDate }} - {{ item.endDate }}</td>
          <td>{{ order_state[item.status] }}</td>
          <td>
            <div class="d-inline">
              <button class="btn btn-secondary btn-sm me-2" style="width: 100px;" onclick="onCancel({{ item.id }})" id="cancel-btn-{{ item.id }}">
                <i class="bi bi-x-circle"></i> Cancel
              </button>
              <button class="btn btn-danger btn-sm" style="width: 100px;" onclick="onDelete({{ item.id }})">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>

            {% if item.status == 1 %}
            <button class="btn btn-primary btn-sm" id="checkin-btn-{{ item.id }}" style="width: 100px;" onclick="onCheckIn({{ item.id }})">
              <i class="bi bi-check-circle"></i> Check In
            </button>
            {% endif %}
            {% if item.status == 2 %}
            <button class="btn btn-primary btn-sm" id="checkout-btn-{{ item.id }}" style="width: 100px;" onclick="onCheckOut({{ item.id }})">
              <i class="bi bi-check-circle"></i> Check Out
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
function onCancel(id) {
  if (confirm('Confirm cancel?')) {
    fetch(`{{ url_for('app.cancel_order') }}?id=${id}`, { method: 'PUT' })
      .then(res => {
        if (!res.ok) throw new Error('Cancellation failed');
        return res.json();
      })
      .then(res => {
        alert('Cancellation successful');

        // Update the order state in the UI
        const orderRow = document.getElementById(`order-row-${id}`);
        const stateCell = orderRow.cells[3]; // Assuming state is the fourth cell
        
        // Update state display
        stateCell.textContent = 'Cancelled';
        
        // Hide cancel button and check-in/check-out buttons
        const cancelBtn = document.getElementById(`cancel-btn-${id}`);
        const checkinBtn = document.getElementById(`checkin-btn-${id}`);
        const checkoutBtn = document.getElementById(`checkout-btn-${id}`);
        
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (checkinBtn) checkinBtn.style.display = 'none';
        if (checkoutBtn) checkoutBtn.style.display = 'none';
      })
      .catch(error => {
        alert('Error: ' + error.message);
      });
  }
}

function onCheckIn(id) {
  fetch(`{{ url_for('app.order_checkin') }}?id=${id}`, { method: 'PUT' })
  .then(res => {
    if (!res.ok) throw new Error('Check-in failed');
    return res.text();
  }).then(res => {
    alert(res);
    location.reload();
  }).catch(error => {
    alert('Error: ' + error.message);
  });
}

function onCheckOut(id) {
  fetch(`{{ url_for('app.order_checkout') }}?id=${id}`, { method: 'PUT' })
  .then(res => {
    if (!res.ok) throw new Error('Check-out failed');
    return res.text();
  }).then(res => {
    alert(res);
    
    // Hide cancel button and show start review button
    const cancelBtn = document.querySelector(`#order-row-${id} .btn-secondary`);
    const startReviewBtn = document.getElementById(`start-review-btn-${id}`);
    
    if (cancelBtn) cancelBtn.style.display = 'none';
    if (startReviewBtn) startReviewBtn.style.display = 'inline-block';
    
    // Update the order state to Checked Out
    const orderRow = document.getElementById(`order-row-${id}`);
    const stateCell = orderRow.cells[3]; // Assuming state is the fourth cell
    stateCell.textContent = 'Checked Out'; // Update to reflect the new state
    
    location.reload();
  }).catch(error => {
    alert('Error: ' + error.message);
  });
}

function onDelete(id) {
  if (confirm('Are you sure you want to delete this order?')) {
    fetch(`{{ url_for('app.delete_order') }}?id=${id}`, { method: 'DELETE' })
    .then(res => res.json()).then(res => {
      alert(res.message);
      location.reload();
    });
  }
}
</script>
{% endblock %}
