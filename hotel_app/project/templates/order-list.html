{% extends 'layout.html' %}

{% block title %}Order List{% endblock %}

{% block content %}
<div class="container col-md-8 mx-auto my-5">
  <div class="table-responsive">
    <table class="table" style="width: 100%; max-width: none;">
      <thead>
        <tr>
          <th scope="col" style="width: 20%;">Name</th>
          <th scope="col" style="width: 20%;">Price</th>
          <th scope="col" style="width: 20%;">Date</th>
          <th scope="col" style="width: 20%;">State</th>
          <th scope="col" style="width: 20%;">Operate</th>
        </tr>
      </thead>
      <tbody>
        {% for item in list %}
        <tr id="order-row-{{ item.id }}">
          <td>{{ item.name }}</td>
          <td>${{ item.price }}</td>
          <td>{{ item.startDate }} - {{ item.endDate }}</td>
          <td>{{ order_state[item.status] }}</td>
          <td>
            <div class="d-inline">
              <!-- <button class="btn btn-secondary btn-sm me-2" style="width: 100px;" onclick="onCancel({{ item.id }})" id="cancel-btn-{{ item.id }}">
                <i class="bi bi-x-circle"></i> Cancel
              </button> -->
              <button class="btn btn-danger btn-sm" style="width: 100px;" onclick="onDelete({{ item.id }})">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
            
            {% if item.status == 0 %}
            <a class="btn btn-primary btn-sm" style="width: 100px;" href="{{ url_for('app.hotel_payment_info') }}?order_id={{ item.id }}">
              <i class="bi bi-check-circle"></i> Go to Pay
            </a>
            {% endif %}
            {% if item.status == 1 %}
            <button class="btn btn-primary btn-sm" id="checkin-btn-{{ item.id }}" style="width: 100px;" onclick="onCheckIn({{ item.id }})">
              <i class="bi bi-check-circle"></i> Check In
            </button>
            <button class="btn btn-secondary btn-sm me-2" style="width: 100px;" onclick="onCancel({{ item.id }})" id="cancel-btn-{{ item.id }}">
              <i class="bi bi-x-circle"></i> Cancel
            </button>
            {% endif %}
            {% if item.status == 2 %}
            <button class="btn btn-primary btn-sm" id="checkout-btn-{{ item.id }}" style="width: 100px;" onclick="onCheckOut({{ item.id }})">
              <i class="bi bi-check-circle"></i> Check Out
            </button>
            {% endif %}

            {% if item.status == 3 %}
            <button class="btn btn-success btn-sm" id="start-review-btn-{{ item.id }}" style="width: 100px;" onclick="startReview({{ item.id }})">
              <i class="bi bi-pencil"></i> Start Review
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function onCancel(id) {
  if (confirm('Confirm cancel?')) {
    fetch(`{{ url_for('app.cancel_order') }}?id=${id}`, { method: 'PUT' })
      .then(res => {
        if (!res.ok) throw new Error('Cancellation failed');
        return res.json();
      })
      .then(res => {
        alert('Cancellation successful');
        // Reload the page to get updated order information
        location.reload(); // Add this line to refresh the page
        const orderRow = document.getElementById(`order-row-${id}`);
        const stateCell = orderRow.cells[3]; // Assuming state is the fourth cell
        stateCell.textContent = 'Cancel';
        
        // Hide buttons
        document.getElementById(`cancel-btn-${id}`).style.display = 'none';
        const checkinBtn = document.getElementById(`checkin-btn-${id}`);
        const checkoutBtn = document.getElementById(`checkout-btn-${id}`);
        if (checkinBtn) checkinBtn.style.display = 'none';
        if (checkoutBtn) checkoutBtn.style.display = 'none';
      })
      .catch(error => {
        alert('Error: ' + error.message);
      });
  }
}

function onCheckIn(id) {
  fetch(`{{ url_for('app.order_checkin') }}?id=${id}`, { method: 'PUT' })
    .then(res => {
      if (!res.ok) throw new Error('Check-in failed');
      return res.text();
    })
    .then(res => {
      alert(res);
      location.reload();
    })
    .catch(error => {
      alert('Error: ' + error.message);
    });
}

function onCheckOut(id) {
  fetch(`{{ url_for('app.order_checkout') }}?id=${id}`, { method: 'PUT' })
    .then(res => {
      if (!res.ok) throw new Error('Check-out failed');
      return res.text(); // Return the response as text
    })
    .then(res => {
      alert(res); // Show success message
      // Reload the page to get updated order information
      location.reload(); // Add this line to refresh the page

      // Get the order row and update the state cell
      const orderRow = document.getElementById(`order-row-${id}`);
      const stateCell = orderRow.cells[3]; // Assuming state is in the fourth cell
      stateCell.textContent = 'Checked Out'; // Update the state

      // Hide the "Cancel" button
      const cancelBtn = document.getElementById(`cancel-btn-${id}`);
      if (cancelBtn) cancelBtn.style.display = 'none';

      // Hide the "Check Out" button
      const checkOutBtn = document.getElementById(`checkout-btn-${id}`);
      if (checkOutBtn) checkOutBtn.style.display = 'none';

      // Show the "Start Review" button
      const startReviewBtn = document.getElementById(`start-review-btn-${id}`);
      if (startReviewBtn) startReviewBtn.style.display = 'inline-block'; // Make it visible
    })
    .catch(error => {
      alert('Error: ' + error.message);
    });
}

function onDelete(id) {
  if (confirm('Are you sure you want to delete this order?')) {
    fetch(`{{ url_for('app.delete_order') }}?id=${id}`, { method: 'DELETE' })
      .then(res => res.json())
      .then(res => {
        alert(res.message);
        location.reload();
      });
  }
}
function startReview(id) {
  // Send a request to update the order state on the server
  fetch(`{{ url_for('app.order_startReview') }}?id=${id}`, { method: 'PUT' })
    .then(res => {
      if (!res.ok) throw new Error('Failed to update state');
      return res.json(); // Assuming the server returns JSON
    })
    .then(res => {
      // Update the order state to "Reviewed" in the UI
      const orderRow = document.getElementById(`order-row-${id}`);
      const stateCell = orderRow.cells[3]; // Assuming state is the fourth cell
      stateCell.textContent = 'Reviewed';

      // Hide all buttons except for the "Delete" button
      const buttons = orderRow.querySelectorAll('button');
      buttons.forEach(button => {
        if (!button.classList.contains('btn-danger')) { // Keep the delete button visible
          button.style.display = 'none';
        }
      });

      // Redirect to the review content page with the order ID
      window.location.href = `{{ url_for('app.review_submit') }}?id=${id}`;
    })
    .catch(error => {
      alert('Error: ' + error.message);
    });
}

</script>
{% endblock %}
