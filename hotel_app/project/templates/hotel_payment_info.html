{% extends 'layout.html' %}

{% block title %}Payment{% endblock %}

{% block content %}
<div class="container col-xl-10 col-xxl-8 px-4 py-5">
  <div class="row g-lg-5 py-5">
      <!-- Use POST method to collect email and card details -->
      <!-- <form method="PUT" class="needs-validation" onsubmit="return onPay(this)"> -->
        <input type="hidden" id="id" value="{{ order_id }}">  <!-- Hidden input for order ID -->
        <h4 class="mb-3">Payment</h4>

        <!-- Email Field (required)
        <div class="mb-3">
          <label for="email" class="form-label">Email Address</label>
          <input type="email" class="form-control" id="email" name="email" required placeholder="you@example.com">
          <div class="invalid-feedback">
            Please enter a valid email address.
          </div>
        </div> -->

        <!-- Card Details -->
        <div class="row gy-3">
          <div class="col-md-6">
            <label for="cc-name" class="form-label">Name on Card</label>
            <input type="text" class="form-control" id="cc-name" name="cc_name" required placeholder="">
            <small class="text-body-secondary">Full name as displayed on card</small>
            <div class="invalid-feedback">
              Name on card is required
            </div>
          </div>

          <div class="col-md-6">
            <label for="cc-number" class="form-label">Credit Card Number</label>
            <input type="text" class="form-control" id="cc-number" name="cc_number" required placeholder="">
            <div class="invalid-feedback">
              Credit card number is required
            </div>
          </div>

          <div class="col-md-3">
            <label for="cc-expiration" class="form-label">Expiration</label>
            <input type="text" class="form-control" id="cc-expiration" name="cc_expiration" required placeholder="MM/YY">
            <div class="invalid-feedback">
              Expiration date is required
            </div>
          </div>

          <div class="col-md-3">
            <label for="cc-cvv" class="form-label">CVV</label>
            <input type="text" class="form-control" id="cc-cvv" name="cc_cvv" required placeholder="">
            <div class="invalid-feedback">
                Security code is required
            </div>
          </div>
        </div>
        
        <hr class="my-4">

        <!-- Continue to Payment Button -->
        <button type="button" class="w-100 btn btn-lg btn-primary" id="continue-pay-btn" onclick="onPay()">Continue to Pay</button>

      <!-- </form> -->
    </div>
</div>
<script>
function onPay() {
  const urlParams = new URLSearchParams(location.search);
  const id = urlParams.get('order_id');
  console.log('onPay called with id:', id);  // debug output

  fetch(`{{ url_for('app.order_pay') }}?id=${id}`, { method: 'PUT' })
    .then(res => {
      if (!res.ok) throw new Error('Update failed: ' + res.status + ' ' + res.statusText);
      return res.text();
    })
    .then(res => {
      const data = JSON.parse(res)
      alert(data.message);
      location.href = '{{ url_for('app.hotel_payment_success') }}?order_id=' + id; // Redirect to payment info
    })
    .catch(error => {
      alert('Error: ' + error.message);
    });
}
</script>

{% endblock %}
