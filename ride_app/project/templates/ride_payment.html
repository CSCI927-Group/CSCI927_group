{% extends 'framework.html' %}
{% block title %}Payment{% endblock %}

{% block body %}
<div class="container w-50">
  <div class="row g-lg-5 py-5">
      <div class="list-group">
        <div class="list-group-item list-group-item-action d-flex gap-3 py-3 shadow">
          <i class="bi bi-car-front fs-1"></i>
          <div class="d-flex gap-2 w-100 justify-content-between">
            <div>
              <h6 class="mb-0">{{ order.name }}</h6>
              <p class="mb-0">{{ order_state[order.state] }}</p>
              <p class="mb-0 text-danger">
                <i class="bi bi-clock-history"></i>
                <span id="countdown"></span>
              </p>
            </div>
            <small class="opacity-50 text-nowrap">${{ order.price }}</small>
          </div>
        </div>
      </div>
      {% if order.state == 1 %}
      <form class="mt-3" onsubmit="return onSubmit(this)" novalidate>
        <h4 class="mb-3">Payment</h4>

        <div class="my-3">
          <div class="form-check">
            <input id="credit" name="paymentMethod" type="radio" class="form-check-input" checked="" required="">
            <label class="form-check-label" for="credit">Credit card</label>
          </div>
          <div class="form-check">
            <input id="debit" name="paymentMethod" type="radio" class="form-check-input" required="">
            <label class="form-check-label" for="debit">Debit card</label>
          </div>
        </div>

        <div class="row gy-3">
          <div class="col-md-6">
            <label for="cc-name" class="form-label">Name on card</label>
            <input type="text" class="form-control" id="cc-name" placeholder="" required="">
            <div class="invalid-feedback">Name on card is required</div>
          </div>
          <div class="col-md-6">
            <label for="cc-number" class="form-label">card number</label>
            <input type="text" class="form-control" id="cc-number" placeholder="" required="">
            <div class="invalid-feedback">Card number is required</div>
          </div>
          <div class="col-md-3">
            <label for="cc-expiration" class="form-label">Expiration</label>
            <input type="text" class="form-control" id="cc-expiration" placeholder="" required="">
            <div class="invalid-feedback">Expiration date required</div>
          </div>
          <div class="col-md-3">
            <label for="cc-cvv" class="form-label">CVV</label>
            <input type="text" class="form-control" id="cc-cvv" placeholder="" required="">
            <div class="invalid-feedback">Security code required</div>
          </div>
        </div>

        <hr class="my-4">

        <button class="w-100 btn btn-primary btn-lg" type="submit">Pay the bill</button>
        <button class="w-100 btn btn-danger btn-lg mt-3" onclick="onCancel()">Cancel the order</button>
      </form>
      {% else %}
      <button class="w-100 mt-5 btn btn-secondary btn-lg" onclick="history.back(-1)">Go Back</button>
      {% endif %}
    </div>
</div>
<script>
function onSubmit(self) {
  event.preventDefault()
  if (self.checkValidity()) {
    fetch('{{ url_for('app.order_pay') }}' + location.search)
      .then(res => res.text()).then(res => {
        location.replace('{{ url_for('app.ride_location') }}' + location.search)
      })
  } else {
    self.classList.add('was-validated')
  }
}

function onCancel() {
  if (confirm('Confirm to cancel?')) {
    fetch('{{ url_for('app.order_cancel') }}' + location.search)
    .then(res => res.text()).then(res => {
      location.reload()
    })
  }
}

function closeOrder() {
  fetch('{{ url_for('app.order_close') }}' + location.search)
    .then(res => res.text()).then(res => {
      location.reload()
    })
}

function countdown() {
  const orderTime = parseInt({{ order.datetime }})
  const endTime = parseInt(Date.now() / 1000)
  const time = orderTime - endTime + 60 * 60
  const minutes = parseInt(time / 60)
  const seconds = Math.abs(time - minutes * 60)
  document.getElementById('countdown').innerText = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`
  if (timehandle <= 0) {
    clearInterval(timehandle)
  }
  return minutes
}


let timehandle = 0
const orderState = {{ order.state }}
if (orderState == 1) {
  if (countdown() <= 0) {
    closeOrder()
  } else {
    timehandle = setInterval(countdown, 1000)
  }
} else {
  document.getElementById('countdown').parentElement.style.visibility = 'hidden'
}
</script>
{% endblock %}